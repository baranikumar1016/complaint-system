<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Complaints - Complaint Management System</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
body {
    min-height: 100vh;
    background: linear-gradient(135deg,#667eea,#764ba2,#f093fb);
    font-family: 'Segoe UI', sans-serif;
}
.navbar {
    background:#fff;
    box-shadow:0 2px 10px rgba(0,0,0,.1);
}
.card {
    border-radius:20px;
    box-shadow:0 20px 60px rgba(0,0,0,.15);
}
.badge-open { background:#fee2e2; color:#dc2626; padding:.4rem .8rem; border-radius:20px; }
.badge-in-progress { background:#fef3c7; color:#d97706; padding:.4rem .8rem; border-radius:20px; }
.badge-resolved { background:#d1fae5; color:#059669; padding:.4rem .8rem; border-radius:20px; }
</style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar px-4 py-3">
    <a class="navbar-brand fw-bold text-primary" href="dashboard.html">
        <i class="bi bi-clipboard-check"></i> Complaint Management System
    </a>
    <div>
        <a href="dashboard.html" class="btn btn-outline-primary me-2">
            <i class="bi bi-arrow-left"></i> Back
        </a>
        <button class="btn btn-danger" onclick="logout()">
            <i class="bi bi-box-arrow-right"></i> Logout
        </button>
    </div>
</nav>

<!-- MAIN -->
<div class="container mt-5">
<div class="card p-4">

<h2 class="text-center mb-4">
<i class="bi bi-list-check"></i> My Complaints
</h2>

<div id="errorAlert" class="alert alert-danger d-none"></div>

<div class="table-responsive">
<table class="table table-hover align-middle">
<thead class="table-primary">
<tr>
<th>ID</th>
<th>Title</th>
<th>Category</th>
<th>Status</th>
<th>Created</th>
<th>Action</th>
</tr>
</thead>
<tbody id="complaintsTableBody"></tbody>
</table>
</div>

</div>
</div>

<!-- VIEW MODAL -->
<div class="modal fade" id="viewModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">

<div class="modal-header">
<h5 class="modal-title">Complaint Details</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
<p><strong>Title:</strong> <span id="mTitle"></span></p>
<p><strong>Category:</strong> <span id="mCategory"></span></p>
<p><strong>Status:</strong> <span id="mStatus"></span></p>
<p><strong>Description:</strong></p>
<div class="border rounded p-2 bg-light" id="mDescription"></div>
</div>

<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
</div>

</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ================= GLOBAL STORE ================= */
let complaintsStore = [];

/* ================= AUTH ================= */
document.addEventListener('DOMContentLoaded', () => {
    const userId = localStorage.getItem('userId');
    const role = localStorage.getItem('role');

    if (!userId) {
        location.href = 'login.html';
        return;
    }
    if (role === 'ADMIN') {
        location.href = 'dashboard.html';
        return;
    }
    loadComplaints(userId);
});

/* ================= LOAD COMPLAINTS ================= */
async function loadComplaints(userId) {
    const tableBody = document.getElementById('complaintsTableBody');
    const errorAlert = document.getElementById('errorAlert');

    try {
        const res = await fetch(`http://localhost:8080/api/complaints/user/${userId}`);
        if (!res.ok) throw new Error(res.status);

        complaintsStore = await res.json();
        tableBody.innerHTML = '';

        if (complaintsStore.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="6" class="text-center text-muted">No complaints found</td>
              </tr>`;
            return;
        }

        complaintsStore.forEach((c, i) => {
            tableBody.innerHTML += `
            <tr>
                <td>#${c.id}</td>
                <td>${escapeHtml(c.title)}</td>
                <td>${escapeHtml(c.category)}</td>
                <td>${statusBadge(c.status)}</td>
                <td>${formatDate(c.createdAt)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary"
                        onclick="openViewModal(${i})">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            </tr>`;
        });

    } catch (e) {
        errorAlert.textContent = 'Failed to load complaints';
        errorAlert.classList.remove('d-none');
    }
}

/* ================= MODAL ================= */
function openViewModal(index) {
    const c = complaintsStore[index];
    document.getElementById('mTitle').innerText = c.title;
    document.getElementById('mCategory').innerText = c.category;
    document.getElementById('mStatus').innerText = c.status;
    document.getElementById('mDescription').innerText = c.description;

    new bootstrap.Modal(document.getElementById('viewModal')).show();
}

/* ================= HELPERS ================= */
function formatDate(d) {
    const date = new Date(d);
    return `${String(date.getDate()).padStart(2,'0')}-${String(date.getMonth()+1).padStart(2,'0')}-${date.getFullYear()}`;
}
function statusBadge(s) {
    if (s === 'OPEN') return `<span class="badge-open">OPEN</span>`;
    if (s === 'IN_PROGRESS') return `<span class="badge-in-progress">IN PROGRESS</span>`;
    if (s === 'RESOLVED') return `<span class="badge-resolved">RESOLVED</span>`;
    return s;
}
function escapeHtml(t) {
    const d = document.createElement('div');
    d.textContent = t;
    return d.innerHTML;
}
function logout() {
    localStorage.clear();
    location.href = 'login.html';
}
</script>

</body>
</html>
