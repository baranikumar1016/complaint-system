<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create Complaint</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
body {
    min-height: 100vh;
    background: linear-gradient(135deg,#667eea,#764ba2,#f093fb);
    font-family: 'Segoe UI', sans-serif;
}
.navbar {
    background: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,.1);
}
.complaint-card {
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,.15);
    padding: 2.5rem;
    max-width: 600px;
    width: 100%;
}
.btn-submit {
    background: linear-gradient(135deg,#667eea,#764ba2);
    color: #fff;
    font-weight: 600;
    border-radius: 12px;
}
.alert-custom {
    display: none;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
}
.alert-success { background:#d4edda; color:#155724; }
.alert-danger { background:#f8d7da; color:#721c24; }
</style>
</head>

<body>

<nav class="navbar px-4 py-3">
    <a class="navbar-brand fw-bold text-primary" href="dashboard.html">
        <i class="bi bi-clipboard-check"></i> Complaint Management
    </a>
    <a href="dashboard.html" class="btn btn-outline-primary">
        <i class="bi bi-arrow-left"></i> Back
    </a>
</nav>

<div class="container d-flex justify-content-center mt-5">
<div class="complaint-card">

<h2 class="text-center mb-4">
<i class="bi bi-plus-circle"></i> Create Complaint
</h2>

<div id="successAlert" class="alert-custom alert-success">
Complaint created successfully! Redirecting...
</div>

<div id="errorAlert" class="alert-custom alert-danger">
<span id="errorMessage"></span>
</div>

<form id="complaintForm">

<div class="mb-3">
<label class="form-label">Title</label>
<input type="text" id="title" class="form-control" required>
</div>

<div class="mb-3">
<label class="form-label">Category</label>
<select id="category" class="form-select" required>
<option value="">Select</option>
<option value="Technical">Technical</option>
<option value="Service">Service</option>
<option value="Billing">Billing</option>
<option value="Other">Other</option>
</select>
</div>

<div class="mb-3">
<label class="form-label">Description</label>
<textarea id="description" class="form-control" rows="4" required></textarea>
</div>

<button type="submit" id="submitBtn" class="btn btn-submit w-100">
Submit Complaint
</button>

</form>
</div>
</div>

<script>
/* ---------- AUTH GUARD ---------- */
document.addEventListener('DOMContentLoaded', () => {
    const userId = localStorage.getItem('userId');
    const role = localStorage.getItem('role');

    if (!userId) {
        location.replace('login.html');
        return;
    }

    if (role === 'ADMIN') {
        alert('Admins cannot create complaints');
        location.replace('dashboard.html');
    }
});

/* ---------- SUBMIT ---------- */
document.getElementById('complaintForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    // ✅ FIX: GET ELEMENTS FIRST
    const titleEl = document.getElementById('title');
    const categoryEl = document.getElementById('category');
    const descriptionEl = document.getElementById('description');

    // ✅ THEN READ VALUES
    const title = titleEl.value.trim();
    const category = categoryEl.value;
    const description = descriptionEl.value.trim();
    const userId = localStorage.getItem('userId');

    const successAlert = document.getElementById('successAlert');
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');
    const submitBtn = document.getElementById('submitBtn');

    successAlert.style.display = 'none';
    errorAlert.style.display = 'none';

    if (!title || !category || !description) {
        errorMessage.textContent = 'All fields are required';
        errorAlert.style.display = 'block';
        return;
    }

    submitBtn.disabled = true;

    // ✅ BACKEND EXPECTS THIS STRUCTURE
    const payload = {
        title: title,
        description: description,
        category: category,
        user: {
            id: Number(userId)
        }
    };

    try {
        const res = await fetch('http://localhost:8080/api/complaints', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const body = await res.json().catch(() => null);

        if (res.ok) {
            successAlert.style.display = 'block';
            document.getElementById('complaintForm').reset();
            setTimeout(() => location.href = 'dashboard.html', 2000);
        } else {
            errorMessage.textContent = body?.message || `HTTP ${res.status}`;
            errorAlert.style.display = 'block';
            submitBtn.disabled = false;
        }

    } catch (err) {
        errorMessage.textContent = 'Backend not reachable';
        errorAlert.style.display = 'block';
        submitBtn.disabled = false;
    }
});
</script>


</body>
</html>
